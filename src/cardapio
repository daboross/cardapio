#!/usr/bin/env python
#
#    Cardapio is an alternative Gnome menu applet, launcher, and much more!
#    Copyright (C) 2010 Thiago Teixeira
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

from cardapio import Cardapio, applet_factory

import gtk
import sys
import dbus
import gnomeapplet
from dbus.mainloop.glib import DBusGMainLoop

DBusGMainLoop(set_as_default=True)
bus = dbus.SessionBus()
bus_request_name = bus.request_name(Cardapio.bus_name_str)

if len(sys.argv) == 2:

	if sys.argv[1] == 'run-in-window':   

		main_window = gtk.Window(gtk.WINDOW_TOPLEVEL)
		main_window.set_title('Cardapio')
		main_window.connect('destroy', gtk.main_quit) 
		app = gnomeapplet.Applet()
		applet_factory(app, None)
		app.reparent(main_window)
		main_window.show_all()
		gtk.gdk.threads_enter()
		gtk.main()
		gtk.gdk.threads_leave()


	elif sys.argv[1] == 'hidden':

		# check if another instance is running
		if bus_request_name == dbus.bus.REQUEST_NAME_REPLY_PRIMARY_OWNER:
			del bus
			Cardapio(hidden = True)
			gtk.gdk.threads_enter()
			gtk.main()
			gtk.gdk.threads_leave()


	elif sys.argv[1] == 'show' or sys.argv[1] == 'show-near-mouse':

		# check if another instance is running
		if bus_request_name == dbus.bus.REQUEST_NAME_REPLY_PRIMARY_OWNER:
			del bus
			Cardapio()
			gtk.gdk.threads_enter()
			gtk.main()
			gtk.gdk.threads_leave()

		else:
			show_hide = bus.get_object(Cardapio.bus_name_str, Cardapio.bus_obj_str).get_dbus_method('show_hide')
			show_near_mouse = (sys.argv[1] == 'show-near-mouse')
			show_hide(show_near_mouse)


else:

	# make sure Cardapio shows even if using Ubuntu's AppMenu
	import os
	os.environ['UBUNTU_MENUPROXY']=''

	gnomeapplet.bonobo_factory('OAFIID:GNOME_Cardapio_Factory', 
			gnomeapplet.Applet.__gtype__, 'Cardapio', '0', applet_factory)

